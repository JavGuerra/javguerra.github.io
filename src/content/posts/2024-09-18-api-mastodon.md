---
route: api-mastodon
title: Accediendo a la API de Mastodon
description: Obtener y mostrar las publicaciones de la red social
author: JavGuerra
pubDate: 2024-09-18
coverImage:
  image: '@/assets/img/mastodon.png'
  alt: Logo Mastodon
tags:
  - JavaScript
  - c√≥digo
  - API
  - servidor
---

En este art√≠culo vamos a ver c√≥mo se puede acceder a la API de Mastodon, un servicio que nos permite, entre otras cosas, obtener las publicaciones m√°s recientes de un usuario concreto.

Recientemente la he usado para mostrar, en el apartado [social](/social) de esta p√°gina, las publicaciones que escribo en la red social, empleando JavaScript del lado del cliente en Astro, es decir, que en una p√°gina .astro he incluido un script que lee y muestra las publicaciones actualizadas de mi cuenta de Mastodon.

En este art√≠culo me centro en la parte de javaScript y no tanto en la integraci√≥n con Astro, ya que, de esta forma, ser√° posible aprovechar la informaci√≥n para que pueda ser usada en otros frameworks o aplicaciones propias.

El lector debe conocer las funciones avanzadas de JavaScript como asincron√≠a y llamadas a APIs para seguir correctamente esta entrada.

# API de Mastodon

Realizar√© la consulta a la [API de Mastodon](https://docs.joinmastodon.org/api/rest/timelines/) mediante la funci√≥n `fetch` de JavaScript.

El acceso a la API no requiere autenticaci√≥n (aunque es posible), por lo que podemos acceder a ella sin ning√∫n tipo de token. Voy a necesitar:

- La url de la instancia de Mastodon, es decir el servidor.
- El id de la cuenta de usuario que quiero consultar.
- El n√∫mero de publicaciones que quiero obtener.

Cuando tengamos estos datos, podremos construir el `endpoint` o url de la API de Mastodon, que ser√° la siguiente:

```
https://<server>/api/v1/accounts/<accountId>/statuses?limit=<limit>
```

Donde:

- `<server>` es la url de la instancia de Mastodon, por ejemplo `mastodon.social` o la de tu propia instancia.
- `<accountId>` es el id de la cuenta que queremos consultar, por ejemplo `1234567890`. Este id se obtendr√≠a de la url de la cuenta, ej.: `https://mastodon.social/@usuario`, como se ver√° enseguida.
- `<limit>` es el n√∫mero de publicaciones que queremos consultar, por ejemplo `10`.

Para obtener el id de la cuenta, uso la siguiente url:

```
https://<server>/api/v1/accounts/lookup?acct=<username>
```

Donde hay que sustituir `<server>` por la url de la instancia de Mastodon y `<username>` por el nombre de usuario de la cuenta que queremos consultar.

Obtengo un json con el id de la cuenta, entre otros datos, como por ejemplo:

```json
{
  "id": "1234567890",
  "username": "usuario",

  ...

}
```

Si queremos consultar las 10 √∫ltimas publicaciones de la cuenta ficticia `@usuario`, que tiene el id ficticio: `1234567890`, en la instancia de Mastodon `https://mastodon.social`, tendr√≠amos que usar la siguiente url:

```
https://mastodon.social/api/v1/accounts/1234567890/statuses?limit=10
```

## Fetch

Ya tenemos formado el endpoint de la API de Mastodon, y para llevar a cabo la consulta necesito usar la funci√≥n `fetch` de JavaScript, que permite realizar peticiones HTTP, y obtener el resultado como un objeto json.

```js
const server = 'https://mastodon.social';
const profileId = '1234567890';
const limit = 10;

const route = `${server}/api/v1/accounts/${profileId}/statuses?limit=${limit}`;

async function getLatestPosts(route) {
  try {
    const response = await fetch(route);
    if (!response.ok) throw new Error(response.statusText);
    return await response.json();
  } catch (error) {
    console.error(error);
    return [];
  }
}
```

Como se aprecia, se trata de una funci√≥n as√≠ncrona con una estructura de los m√°s com√∫n, que se ejecutar√° de manera independiente, y cuando se haya terminado de ejecutar, me permitir√° seguir con la ejecuci√≥n del c√≥digo.

Para llamar a la funci√≥n, uso:

```js
const posts = await getLatestPosts(route);
```

Con `await`, se espera a que la funci√≥n `getLatestPosts` termine de ejecutarse, y luego es posible usar el array `posts` para mostrar las publicaciones en nuestra p√°gina, siempre que no se haya producido ning√∫n error.

## Mostrando las publicaciones

All√≠ donde vamos a mostrar las publicaciones, voy a usar un elemento `<ul>` con el `id="posts"` para definir una lista de publicaciones, y un elemento `<li>` para cada publicaci√≥n.

Incluyo el siguiente c√≥digo HTML en la p√°gina:

```html
<ul id="posts">
  Cargando...
</ul>
```

Y luego, mediante el script de JavaScript, sustituir√© el contenido del elemento `<ul>` con las publicaciones obtenidas y formateadas:

```js
function displayPosts(posts) {
  const postsElement = document.getElementById('posts');
  if (posts && posts.length > 0) {
    postsElement.innerHTML = `
        <h2>√öltimas publicaciones</h2>
        ${posts.map(post => `
          <li class="post">
            ${post.reblog === null 
              ? post.content
              : `${post.reblog.content} <small>‚ôªÔ∏è Republicado </small>`}
            ${post.reblog === null && post.content === ""
              ? `Contenido multimedia <a href="${post.url}">üëÅÔ∏è Ver en origen ‚Üí</a><br />` : ''}
            <a href="${post.reblog === null ? post.url : post.reblog.url}">
              <small>üì¢ ${new Date(post.created_at).toLocaleString()}</small>              
            </a>
          </li>
        `).join('')}
      `;
  } else {
    postsElement.innerHTML = '<p>No se encontraron posts.</p>';
  }  
}
```

Vamos por partes:

Primero obtengo el elemento `<ul>` con el id `posts` del DOM, y lo guardo en una variable `postsElement` para poder referirme a √©l en el script.

```js
const postsElement = document.getElementById('posts');
```

Compruebo que hay publicaciones y que el array `posts` no est√© vac√≠o. Si no es as√≠, defino el contenido del elemento `<ul>` con el siguiente c√≥digo: 

```js    
postsElement.innerHTML = '<p>No se encontraron posts.</p>';
```

Si hemos obtenidos publicaciones, hago uso de la siguiente estructura:

```js
postsElement.innerHTML = `
    <h2>√öltimas publicaciones</h2>
    ${posts.map(post => `

        // c√≥digo para mostrar cada publicaci√≥n

    `).join('')}
`;
```

Con la funci√≥n `map` puedo iterar sobre cada elemento del objeto `posts` y acceder a cada una de las publicaciones, y luego junto todos los elementos formateados en una cadena de texto mediante la funci√≥n `join`. El resultado se incluir√° en el elemento `<ul>` con el id `posts` mediante el m√©todo `innerHTML` de postElement. Es decir, obtengo cada publicaci√≥n, esta se formatea, y se concatena o a√±ade a la cadena de texto que conforma el contenido del elemento `<ul>`; las publicaciones.

## Formatear la publicaci√≥n

Para formatear las publicaciones, voy a usar una estructura de elementos `<li>` para cada publicaci√≥n, como dije, y un elemento `<a>` para enlazar a la publicaci√≥n original. Lo que quiero conseguir se parece a esto:

```html
<li class="post">
  Este es un ejemplo de una publicaci√≥n en Mastodon.
  <a href="https://mastodon.social/@usuario/109292343224519197">
    <small>18/9/2024, 1:23:45</small>
  </a>
</li>
```

De cada post obtengo el contenido de la publicaci√≥n, y el enlace a la publicaci√≥n, y luego lo formateo para que se vea como se muestra arriba, mediante el siguiente c√≥digo:

```js
<li class="post">
    ${post.reblog === null 
        ? post.content
        : `${post.reblog.content} <small>‚ôªÔ∏è Republicado </small>`}
    ${post.reblog === null && post.content === ""
        ? `Contenido multimedia <a href="${post.url}">üëÅÔ∏è Ver en origen ‚Üí</a><br />` : ''}
    <a href="${post.reblog === null ? post.url : post.reblog.url}">
        <small>üì¢ ${new Date(post.created_at).toLocaleString()}</small>              
    </a>
</li>
```

Como las publicaciones pueden ser republicaciones, es decir, publicaciones compartidas de otros, compruebo si este es el caso con `post.reblog === null` Si no hay republicaci√≥n, osea, si es null, incluyo el contenido del post con `post.content`, y si hay republicaci√≥n, incluyo el contenido de la republicaci√≥n con `post.reblog.content`.

Luego compruebo si el contenido es multimedia y no incluye texto, mediante `post.reblog === null && post.content === "`, y si es as√≠, incluyo un enlace a la versi√≥n original de la publicaci√≥n con `post.url`. Si no es el caso, no incluyo nada `''`.

Por √∫ltimo, para enlazar a la publicaci√≥n en Mastodon, tambi√©n debo determinar si estoy ante una publicaci√≥n original o republicada. En el primer caso uso el enlace a la publicaci√≥n, y en el segundo caso uso el enlace a la republicaci√≥n con `post.reblog === null ? post.url : post.reblog.url`.

Para mostrar la fecha, uso la funci√≥n `toLocaleString` de JavaScript, que me permite obtener la fecha en formato local con `new Date(post.created_at).toLocaleString()`.

Es posible llamar a la funci√≥n `displayPosts` mediante:

```js
displayPosts(posts);
```

Siendo `posts` el objeto de publicaciones en json obtenido de la API de Mastodon.

# El c√≥digo completo

El c√≥digo siguiente incluye el contenido mostrado hasta ahora en el art√≠culo:

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicaciones de Mastodon</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <h1>Mastodon</h1>

    <ul id="posts">
        Cargando...
    </ul>

<script>
    // Sustituye los valores siguientes para adaptarlo a tu propio uso
    const server = 'https://mastodon.social';
    const profileId = '1234567890';
    const limit = 10;

    const route = `${server}/api/v1/accounts/${profileId}/statuses?limit=${limit}`;

    async function getLatestPosts(route) {
        try {
            const response = await fetch(route);
            if (!response.ok) throw new Error(response.statusText);
            return await response.json();
        } catch (error) {
            console.error(error);
            return [];
        }
    }

    function displayPosts(posts) {
        const postsElement = document.getElementById('posts');
        if (posts && posts.length > 0) {
            postsElement.innerHTML = `
                <h2>√öltimas publicaciones</h2>
                ${posts.map(post => `
                <li class="post">
                    ${post.reblog === null 
                    ? post.content
                    : `${post.reblog.content} <small>‚ôªÔ∏è Republicado </small>`}
                    ${post.reblog === null && post.content === ""
                    ? `Contenido multimedia <a href="${post.url}">üëÅÔ∏è Ver en origen ‚Üí</a><br />` : ''}
                    <a href="${post.reblog === null ? post.url : post.reblog.url}">
                    <small>üì¢ ${new Date(post.created_at).toLocaleString()}</small>              
                    </a>
                </li>
                `).join('')}
            `;
        } else {
            postsElement.innerHTML = '<p>No se encontraron posts.</p>';
        }  
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const posts = await getLatestPosts(route);
      displayPosts(posts);
    });
</script>

</body>
</html>
```

Mediante el evento asociado a la carga de la p√°gina `DOMContentLoaded`, se inicia la petici√≥n as√≠ncrona a la API.

No olvides sustituir los valores de `server`, `profileId` y `limit` con los que correspondan a tu propio perfil de Mastodon o el del perfil que desees consultar.

## Estilos

Para que el contenido se vea correctamente, es necesario definir algunos estilos en el archivo `style.css`.

```css
.invisible {
  display: inline-block;
  font-size: 0;
  height: 0;
  line-height: 0;
  position: absolute;
  width: 0;
}
.invisible img,
.invisible svg {
  border: 0 !important;
  height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  width: 0 !important;
}
.ellipsis:after {
  content: "‚Ä¶";
}
```
Estos estilos son los que usa el propio Mastodon para mostrar las publicaciones.

La clase `.invisible` se aplica a los elementos que quiero que no se vean. Esto es necesario para evitar saltos de l√≠nea y espacios en blanco en el contenido de las publicaciones debido a su formateo original.

Se incluye tambi√©n la clase `.invisible` para im√°genes y vectores SVG. Si bien no se usan en este ejemplo, pueden ser de utilidad si decides mostrar el contenido multimedia de las publicaciones.

Por su parte, la clase `.ellipsis` se usa para mostrar puntos suspensivos `‚Ä¶` al final de los enlaces acortados.

A partir de estos estilos es posible aplicar estilos propios al contenido mostrado.

# Saber m√°s

- [Mastodon](https://es.wikipedia.org/wiki/Mastodon)
- [Mastodon API](https://docs.joinmastodon.org/api/rest/timelines/)
- Ejemplo de uso: [Social](/social)