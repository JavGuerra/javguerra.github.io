---
import { getCollection } from 'astro:content';
import { getSlugName } from '@/scripts/urlUtils';
import BlogPostCard from "@/components/BlogPostCard.astro";

const allPosts: Record<string, any>[] = await getCollection('posts');

let sortedPosts;
if (allPosts.length) {
  sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
  )

  const title = sortedPosts[0].data.title;
  const prefixedTitle = title.startsWith("Nuevo: ") ? title : `Nuevo: ${title}`;   
  sortedPosts[0].data.title = prefixedTitle;
}
---

<ul id="randomPostContainer" class="my-8 text-center md:text-left">
  <div id="blogPost">
    {sortedPosts && sortedPosts.map((post, index) => (
      <div class={index === 0 ? '' : 'hidden'}data-post-index={index}>
        <BlogPostCard
          frontmatter={post.data}
          href={`${post.data.route || getSlugName(post.slug)}`}
        />
      </div>
    ))}
  </div>
</ul>

<script is:inline>
  let interval;

  function handleContentLoaded() {
    const $postContainers = document.querySelectorAll('[data-post-index]');
    let currentIndex = randomIndex = 0;
    const maxAttempts = 5;

    function showRandomPost() {
      if ($postContainers.length <= 1) return;

      let attempts = 0;
      do {
        randomIndex = Math.floor(Math.random() * $postContainers.length);
        attempts++;
      } while (randomIndex === currentIndex && attempts < maxAttempts && $postContainers.length > 1);

      const $actual = $postContainers[currentIndex];
      const $next = $postContainers[randomIndex];

      $actual.classList.add('fade-out');

      $actual.addEventListener('transitionend', function handler() {

        $actual.classList.add('hidden');
        $actual.classList.remove('fade-out');

        $next.classList.add('fade-in');
        $next.classList.remove('hidden');
        void $next.offsetWidth; // force reflow to enable transition
        
        setTimeout(() => {
          $next.classList.remove('fade-in');
          currentIndex = randomIndex;
        }, 550);

        $actual.removeEventListener('transitionend', handler);
      }, { once: true });
    }

    interval = setInterval(showRandomPost, 7000);
  }

  function cleanup() {
    if (interval) {
      clearInterval(interval);
    }
  }

  document.addEventListener('astro:page-load', handleContentLoaded);
  document.addEventListener('astro:before-preparation', cleanup); 
</script>

<style>
  .fade-out {
    opacity: 0;
    transition: opacity 0.5s ease-out;
  }

  .fade-in {
    opacity: 1;
    transition: opacity 0.5s ease-in;
  }
</style>
